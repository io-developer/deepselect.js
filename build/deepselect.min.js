/**
 * Configurable deep sub-select maker
 * Not requires jQuery or other libs
 * @author Sergey Sedyshev
 * @see repository https://github.com/io-developer/deepselect.js
 * @see find more on github https://github.com/io-developer
 * @build 2015-06-02
 */

var deepselect=function(a){return deepselect.create(a)};deepselect.events={select:"deepselectSelect",selectStart:"deepselectStart",selectComplete:"deepselectSelectComplete"},deepselect.cssClasses={main:"deepselect",node:"deepselect-node",nodeContainer:"deepselect-node-container",nodeOption:"deepselect-node-option"},deepselect.create=function(a){var b=a.dataProvider||new deepselect.DataProvider(a.data),c=[],d=a.cssClasses||[];for(var e in deepselect.cssClasses)c[e]=d[e]||deepselect.cssClasses[e];var f=document.createElement("div");f.className=c.main;var g=new deepselect.Renderer(f,c,a.enableLabels,a.label,a.labelSelectable,a.labelValue),h=new deepselect.Controller(b,f,g);return f.isCompleted=h.isCompleted,f.currentIndexes=h.currentIndexes,f.currentValues=h.currentValues,f.controller=function(){return h},f.onSelect=function(a){f.addEventListener(deepselect.events.select,a.bind(f))},f.onSelectStart=function(a){f.addEventListener(deepselect.events.selectStart,a.bind(f))},f.onSelectComplete=function(a){f.addEventListener(deepselect.events.selectComplete,a.bind(f))},f},deepselect.Controller=function(a,b,c){function d(){o=[],p=[];for(var b=c.getValues(),d=-1,e=n.length;++d<e;){var f=a.getItemAt(n.slice(0,d+1));o.push(f),p.push(f?f.value:b[d])}}function e(b){var d=a.getItemAt(b),e=c.addNode(d);return e&&f(e,b),e}function f(a,b){var d=c.isEnableLabels()?1:0;a.addEventListener("change",function(c){var e=a.selectedIndex-d;k.handleSelectAt(b.concat(e))})}function g(a){var b;return document.createEvent?(b=document.createEvent("Event"),b.initEvent(a,!0,!1)):b=new Event(a),b}function h(a){var c=g(a);c.selectedIndexes=n.concat(),c.selectedItems=o.concat(),c.selectedValues=p.concat(),b.dispatchEvent(c)}function i(){d(),h(deepselect.events.select),m&&(m=!0,h(deepselect.events.selectStart))}function j(){m=!1,d(),h(deepselect.events.selectComplete)}var k=this,l=(window.navigator.userAgent.indexOf("MSIE ")>-1,!1),m=!1,n=[],o=[],p=[],q=0;k.isCompleted=function(){return l},k.getRenderer=function(){return c},k.getDataProvider=function(){return a},k.currentIndexes=function(a){return a&&k.selectByIndexes(a),d(),n.concat()},k.currentValues=function(a){return a&&k.selectByValues(a),d(),p.concat()},k.selectByIndexes=function(a){k.handleSelectAt(a.slice(0,a.length-1)),k.handleSelectAt(a.slice(0,a.length)),c.setSelectedIndexes(a)},k.selectByValues=function(b){k.selectByIndexes(a.getIndexesByVals(b))},k.handleSelectAt=function(b){b=b||[];var d=b[b.length-1],f=a.getItemsAt(b);if(f||!(d>=0)){for(var g=-1,h=Math.min(b.length,n.length);++g<h&&b[g]==n[g];);var k=--g;for(h=n.length;++k<h;)n.pop(),c.popNode();var m=null;for(h=b.length;++g<h;){var o=b[g];n.push(o),m=e(n.concat())}0==h&&(n=[],c.popNode(),m=e(n.concat())),++q,m&&arguments.callee(b.concat(c.isEnableLabels()?-1:0)),--q,0==q&&(l=!m,i(),l&&j())}},k.handleSelectAt()},deepselect.Renderer=function(a,b,c,d,e,f){var g=this,h=[],i=[];b=b||deepselect.cssClasses,d=d||"Choose...",f=f||"",g.isEnableLabels=function(){return c},g.getValues=function(){for(var a=[],b=-1,c=h.length;++b<c;){var d=h[b];d&&a.push(d.value)}return a},g.setSelectedIndexes=function(a){for(var b=c?1:0,d=-1,e=Math.min(a.length,h.length);++d<e;){var f=h[d];f.selectedIndex=a[d]+b}},g.popNode=function(){i.length>0&&(h.pop(),child=i.pop(),child&&a.removeChild(child))},g.addNode=function(j){var k=null,l=(j?j.items:null)||[],m=l.length;if(m>0){if(k=document.createElement("select"),k.className=b.node,c){var n={};n.name=j.label||d,n.value=void 0!==j.labelValue?j.labelValue:f,n.selected=!0,n.disabled=!(void 0!==j.labelSelectable?j.labelSelectable:e),k.appendChild(g.renderNodeItem(n))}for(var o=-1;++o<m;)k.appendChild(g.renderNodeItem(l[o]));var p=g.renderNodeContainer(k);a.appendChild(p)}return h.push(k),i.push(p),k},g.renderNodeContainer=function(a){return el=document.createElement("div"),el.className=b.nodeContainer,el.appendChild(a),el},g.renderNodeItem=function(a){var c=document.createTextNode(a.name),d=document.createElement("option");return d.className=b.nodeOption,d.appendChild(c),d.setAttribute("value",void 0!==a.value?a.value:""),a.disabled&&d.setAttribute("disabled","disabled"),a.selected&&d.setAttribute("selected","selected"),d}},deepselect.DataProvider=function(a){function b(b){for(var c=a,d=c.items,e=-1,f=b.length;++e<f;){var g=b[e];if(!(g>=0&&g<d.length)){c=null,d=null;break}c=d[g],d=c.items||[]}return{item:c,items:d}}var c=this;c.getItemAt=function(a){return b(a).item},c.getItemsAt=function(a){return b(a).items},c.getIndexesByVals=function(b){for(var c=b.concat(),d=[],e=a.items;c.length;){for(var f=c.shift(),g=e.length;g-->0&&e[g].value!=f;);if(d.push(g),!(g>-1&&(e=e[g].items)))break}return d}};